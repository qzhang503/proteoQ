---
title: How do I run proteoQ
author: Qiang Zhang
date: '2020-04-15'
slug: how-do-i-run-proteoq
categories: []
tags: []
subtitle: ''
summary: ''
authors: []
lastmod: '2020-04-15T12:04:43-05:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---


The framework of proteoQ can be divided conceptually into the units of data normalization and informatic analysis.  

## Data normalization
The modules in data normalization need to be run in order, starting with the upload of metadata by `load_expts` and ending with the compilation of protein table by `standPrn`.  

```{r, echo=FALSE}
par(mar = c(0, 1, 0, 1))

foo <- function() {
  flowchart <- list(name = "preprocessing", 
                  children = list(list(name = "metadata",
                                       children = list(
                                         list(name = "load_expts", 
                                              children = list(
                                                list(name = "expt_smry.xlsx", 
                                                     children = list(
                                                       list(name = "Sample_ID"), 
                                                       list(name = "TMT_Set"),
                                                       list(name = "LCMS_Injection"),
                                                       list(name = "TMT_Channel"),
                                                       list(name = "Reference"),
                                                       list(name = "..."))), 
                                                list(name = "frac_smry.xlsx", 
                                                     children = list(
                                                       list(name = "RAW_File"),
                                                       list(name = "PSM_File"),
                                                       list(name = "..."),
                                                       list(name = "extract_psm_raws"),
                                                       list(name = "extract_raws")
                                                       ))))
                                       )), 
                                  list(name = "normalization",
                                       children = list(
                                         list(name = "normPSM",
                                              children = list(
                                                list(name = "fasta", 
                                                     children = list(
                                                       list(name = "UniProt"),
                                                       list(name = "RefSeq")
                                                     )), 
                                                list(name = "entrez",
                                                     children = list(
                                                       list(name = "Uni2Entrez"),
                                                       list(name = "Ref2Entrez")
                                                     )), 
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "filter_ = ...")
                                                     ))
                                              )),
                                         list(name = "purgePSM", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "width, height, etc.")
                                                     ))
                                              )),
                                         list(name = "PSM2Pep", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "filter_ = ...")
                                                     ))
                                              )),
                                         list(name = "mergePep",
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "filter_ = ...")
                                                     ))
                                              )),
                                         list(name = "standPep", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "slice_ = ...")
                                                     ))
                                              )),
                                         list(name = "purgePep", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "width, height...")
                                                     ))
                                              )),
                                         list(name = "Pep2Prn",
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "filter_ = ...")
                                                     ))
                                              )),
                                         list(name = "standPrn", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "slice_ = ...")
                                                     ))
                                              ))
                                       )),
                                  list(name = "hypothesis tests",
                                       children = list(
                                         list(name = "pepSig", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "grp_1 = ~ Term[...]"),
                                                       list(name = "filter_ = ...")
                                                     ))
                                              )),
                                         list(name = "prnSig", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "grp_1 = ~ Term[...]"),
                                                       list(name = "filter_ = ...")
                                                     ))
                                              )),
                                         list(name = "pepVol", 
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "width, height...")
                                                     ))
                                              )),
                                         list(name = "prnVol",
                                              children = list(
                                                list(name = "dot-dot-dot", 
                                                     children = list(
                                                       list(name = "width, height...")
                                                     ))
                                              ))
                                       )
                                  )
                  ))
  

}

foo_peps <- function() {
  library(magrittr)
  library(dplyr)
  library(tidyr)
  library(networkD3)
  library(data.tree)
  
  pep_levels_12 <- tibble(type = "Peptides", 
                          func_peps = c("pepHist", "pepHM", "pepMDS", "pepPCA", 
                                        "pepCorr_logFC", "pepCorr_logInt",
                                        "anal_pepNMF", "plot_pepNMFCoef", "plot_pepNMFCon", 
                                        "pepVol"))
  pep_levels_23 <- tibble(func_peps = c(rep("pepHist", 2), rep("pepHM", 3), rep("pepMDS",2), 
                                        rep("pepPCA", 2), rep("pepCorr_logFC", 2) , 
                                        rep("pepCorr_logInt", 2),
                                        rep("anal_pepNMF", 2), rep("plot_pepNMFCoef", 2),
                                        rep("plot_pepNMFCon", 2), rep("pepVol", 2)), 
                          pars_pep = c("filter_", "xmin, xmax, ...", # pepHist
                                       "filter_", "arrange_", "xmin, xmax, ...", # pepHM
                                       "filter_", "width, height, ...", # pepMDS
                                       "filter_", "width, height, ...", # pepPCA
                                       "filter_", "width, height, ...", # pepCorr_logFC
                                       "filter_", "width, height, ...", # pepCorr_logInt
                                       "filter_", "NMF arguments", # anal_pepNMF
                                       "filter2_", "pheatmap arguments", # plot_pepNMFCoef
                                       "filter2_", "pheatmap arguments", # plot_pepNMFCon
                                       "filter_", "xco, yco, ..." # pepVol
                          ))
  peptides <- left_join(pep_levels_12, pep_levels_23, by = "func_peps") 
  
  pep_tree <- peptides %>% 
    tidyr::unite(col="pathString", type, func_peps, pars_pep, sep="-", remove=FALSE) %>%
    dplyr::select(-type) %>% 
    data.tree::as.Node(pathDelimiter = "-")
  
  diagonalNetwork(ToListExplicit(pep_tree, unname = TRUE ), 
                  linkColour = "#ccc",
                  nodeColour = "#fff",
                  # nodeStroke = nodeStrokeJS,
                  textColour = "#cccccc")

}

flowchart <- list(name = "preprocessing", 
                children = list(list(name = "metadata",
                                     children = list(
                                       list(name = "load_expts", 
                                            children = list(
                                              list(name = "expt_smry.xlsx", 
                                                   children = list(
                                                     list(name = "Sample_ID"), 
                                                     list(name = "TMT_Set"),
                                                     list(name = "LCMS_Injection"),
                                                     list(name = "TMT_Channel"),
                                                     list(name = "Reference"),
                                                     list(name = "..."))), 
                                              list(name = "frac_smry.xlsx", 
                                                   children = list(
                                                     list(name = "RAW_File"),
                                                     list(name = "PSM_File"),
                                                     list(name = "..."),
                                                     list(name = "extract_psm_raws"),
                                                     list(name = "extract_raws")
                                                     ))))
                                     )), 
                                list(name = "normalization",
                                     children = list(
                                       list(name = "normPSM",
                                            children = list(
                                              list(name = "fasta", 
                                                   children = list(
                                                     list(name = "UniProt"),
                                                     list(name = "RefSeq")
                                                   )), 
                                              list(name = "entrez",
                                                   children = list(
                                                     list(name = "Uni2Entrez"),
                                                     list(name = "Ref2Entrez")
                                                   )), 
                                              list(name = "filter_ = ...")
                                            )),
                                       list(name = "purgePSM", 
                                            children = list(
                                              list(name = "width, height, ...")
                                            )),
                                       list(name = "PSM2Pep", 
                                            children = list(
                                              list(name = "filter_ = ...")
                                            )),
                                       list(name = "mergePep",
                                            children = list(
                                              list(name = "filter_ = ...")
                                            )),
                                       list(name = "standPep", 
                                            children = list(
                                              list(name = "slice_ = ...")
                                            )),
                                       list(name = "purgePep", 
                                            children = list(
                                              list(name = "width, height, ...")
                                            )),
                                       list(name = "Pep2Prn",
                                            children = list(
                                              list(name = "filter_ = ...")
                                            )),
                                       list(name = "standPrn", 
                                            children = list(
                                              list(name = "slice_ = ...")
                                            ))
                                     )),
                                list(name = "hypothesis tests",
                                     children = list(
                                       list(name = "pepSig", 
                                            children = list(
                                              list(name = "grp_1 = ~ Term[...]"), 
                                              list(name = "grp_2 = ~ Term_2[...]"), 
                                              list(name = "filter_ = ...")
                                            )),
                                       list(name = "prnSig", 
                                            children = list(
                                              list(name = "grp_1 = ~ Term[...]"), 
                                              list(name = "grp_2 = ~ Term_2[...]"), 
                                              list(name = "filter_ = ...")
                                            ))
                                     )
                                )
                ))

# https://stackoverflow.com/questions/42568997/r-networkd3-color-node-stroke-for-radialnetwork
# https://cran.r-project.org/web/packages/data.tree/vignettes/data.tree.html

library(magrittr)
n_nodes <- rapply(flowchart, length) %>% length()
# nms <- rapply(flowchart, function(x) x %>% `[`(1))

func_nodes <- c(5:17)
func_color <- "#de2d26"

optfunc_nodes <- c(7, 11, 14:17, 47:48, 51:55)
optfunc_color <- "#fdae6b"

colorVector <- rep("steelblue", n_nodes) %>% 
  replace(., func_nodes, func_color) %>% 
  replace(., optfunc_nodes, optfunc_color)
  
jsarray <- paste0('["', paste(colorVector, collapse = '", "'), '"]')
nodeStrokeJS <- htmlwidgets::JS(paste0('function(d, i) { return ', jsarray, '[i]; }'))

networkD3::diagonalNetwork(List = flowchart, fontSize = 15, nodeStroke = nodeStrokeJS, 
                           width = 600, height = 900) 
                           
```

In stead of putting all components into one large unit, utilities in data normalization were divided into smaller pieces for flexible workflows. One of the features is that we may tailor various `filter_` conditions  in individual steps, to remove inappropriate entries. Another example is that we may execute repetitively `standPep` and `standPrn` with different `slice_` conditions to achieve the mixed-bed normalization of data.^[See also the help documents in proteoQ and the online [README](https://github.com/qzhang503/proteoQ)]  

> The modules of `purgePSM` and `purgePep` may be viewed as optional in that they do not add columns to the input datum.  

After peptide and protein normalization, we may apply `pepSig` and `prnSig` to calculate significance p-values. Methods based on long-run frequency interpretation of probability are used in these two modules.  

The modules of `pepSig` and `prnSig`, which calculate significance p-values, are arguably part of the normalization steps. One benefit in having them early in the procedure is to allow data subsetting against p-values in downstream analyses. For instance, we may subset data by the lowest p-values for heat map visualization. In addition, `prnSig` is required for modules such as `prnGSPA` that uses protein p-values. For the quasi-essentiality, they were assigned to the normalization unit.  

> *NB*: every time sample(s) were [voided](https://proteoq.netlify.com/post/sample-exlusion-from-metadata/) from `expt_smry.xlsx`, all the units in data normalization need to be re-executed to update the result files of `Peptide.txt`, `Protein.txt` etc. A cleaner alternative is to carry out the analysis from scratch as a brand new task.  

## Informatic analysis
The proteoQ modules in informatics can be executed more independently without specific orders. For instance, we may run from `GSEA` to `Heat map` or vice versa. It is also a valid idea to run alongside utilities under the same module. In the example of protein Trend analysis, it comprises the analysis part of `anal_prnTrend` and the visualization part of `plot_prnTrend`. We will need to first execute `anal_prnTrend`, and then `plot_prnTrend`.  

```{r chart_2, echo=FALSE, message=FALSE, warning=FALSE}
library(magrittr)
library(dplyr)
library(tidyr)
library(networkD3)
library(data.tree)

my_nodes <- tibble(
  name = c("Peptide", "Protein", 
           
           "Histogram", "Heat map", "MDS", "PCA", "Correlation", "Volcano plot", "NMF", 
           "Trend", "GSEA", "GSVA", "GSPA", 
           
           "pepHist", "prnHist", "pepHM", "prnHM", "pepMDS", "prnMDS", "pepPCA", "prnPCA",
           "pepCorr_logFC", "pepCorr_logInt", "prnCorr_logFC", "prnCorr_logInt", 
           "pepVol", "prnVol", 
           "anal_pepNMF", "plot_pepNMFCoef", "plot_pepNMFCon", 
           "anal_prnNMF", "plot_prnNMFCoef", "plot_prnNMFCon", "plot_metaNMF", 
           "anal_prnTrend", "plot_prnTrend", "prnGSEA", "prnGSVA",
           "prnGSPA", "prnGSPAHM", "gspaMap", 
           
           "filter_", "filter2_", "arrange_", "ggplot2", "pheatmap"
           )
) %>% data.frame()

my_links <- tibble(
  source = 0,
  target = c(2:8),
  value = 1,
) %>% 
  bind_rows(
    tibble(
      source = 1,
      target = c(2:12),
      value = 1,
    )
  ) %>% # hist
  bind_rows(
    tibble(
      source = 2,
      target = c(13:14),
      value = 1,
    )
  ) %>% # hm
  bind_rows(
    tibble(
      source = 3,
      target = c(15:16),
      value = 1,
    )
  ) %>% # mds
  bind_rows(
    tibble(
      source = 4,
      target = c(17:18),
      value = 1,
    )
  ) %>% # pca
  bind_rows(
    tibble(
      source = 5,
      target = c(19:20),
      value = 1,
    )
  ) %>% # corr
  bind_rows(
    tibble(
      source = 6,
      target = c(21:24),
      value = 1,
    )
  ) %>% # vol
  bind_rows(
    tibble(
      source = 7,
      target = c(25:26),
      value = 1,
    )
  ) %>% # nmf
  bind_rows(
    tibble(
      source = 8,
      target = c(27:33),
      value = 1,
    )
  ) %>% # trend
  bind_rows(
    tibble(
      source = 9,
      target = c(34:35),
      value = 1,
    )
  ) %>% # gsea
  bind_rows(
    tibble(
      source = 10,
      target = c(36),
      value = 1,
    )
  ) %>% # gsva
  bind_rows(
    tibble(
      source = 11,
      target = c(37),
      value = 1,
    )
  ) %>% # gspa
  bind_rows(
    tibble(
      source = 12,
      target = c(38:40),
      value = 1,
    )
  ) %>% # filter
  bind_rows(
    tibble(
      source = c(13:27, 30, 33:34, 36:40),
      target = 41,
      value = 1,
    )
  ) %>% # filter2
  bind_rows(
    tibble(
      source = c(35, 28:29, 31:32, 39:40),
      target = 42,
      value = 1,
    )
  ) %>% # arrange
  bind_rows(
    tibble(
      source = c(15:16, 33),
      target = 43,
      value = 1,
    )
  ) %>% # ggplot2
  bind_rows(
    tibble(
      source = c(13:14, 17:20, 25:26, 35, 40),
      target = 44,
      value = 1,
    )
  ) %>% # pheatmap
  bind_rows(
    tibble(
      source = c(15:16, 28:29, 31:33, 39),
      target = 45,
      value = 1,
    )
  ) %>% 
  data.frame()

my_links <- my_links %>% mutate(group = NA)
my_links$group[1:7] <- "Peptide"
my_links$group[8:18] <- "Protein"

my_links$group[which(my_links$target == 41)] <- "filter"
my_links$group[which(my_links$target == 42)] <- "filter2"
my_links$group[which(my_links$target == 43)] <- "arrange"
my_links$group[which(my_links$target == 44)] <- "ggplot2"
my_links$group[which(my_links$target == 45)] <- "pheatmap"

sankeyNetwork(Links = my_links, Nodes = my_nodes, Source = 'source',
              Target = 'target', Value = 'value', NodeID = 'name',
              units = 'TWh', fontSize = 11, nodeWidth = 30, 
              LinkGroup = "group", width = 800, height = 500)
```

Variable arguments (varargs) are broadly employed in proteoQ, typically for the purpose of flexible data row subsetting and ordering. The data files coming out of `Data normalization` are considered primary and termed `df`. We can then apply varargs of `filter_` and `arrange_` for utilities that read `df`. For example, `prnHM` imports the protein table, let's say `Protein.txt`, and can take `filter_` and `arrange_` varargs for row filtration and ordering, respectively.  

There are also utilities that read data files from informatic analysis. These files are termed secondary data files, `df2`. One example is `plot_prnNMFCon` that imports the consensus findings from `anal_prnNMF` for heat map visualization. The corresponding vararg for data filtration is `filter2_`.  

The `gspaMap` is more unique in that it processes both `df`, the protein table from `Data normalization`, and `df2`, the gene set results from `prnGSPA`. Thus, it is possible to apply both `filter_` and `filter2_` when calling the module.^[See also `?proteoQ::gspaMap` for details.]  

The graphic visualization is typically facilitated through `ggplot2` or `pheatmap`, with the later being used exclusively for heat maps. Parameter passing via `dot-dot-dot` is generally applicable. To take advantage of the full-fledged `ggplot2`, results are exported when possible. In the following example, we pass the findings from `prnMDS` for external `ggplot2` visualization:  

```{r, echo = TRUE, eval=FALSE}
library(ggplot2)
res <- prnMDS()
p <- ggplot(res) + ...
```
